---
title: chaos_packet_drop
sidebar_position: 20
---

import Tabs from '@theme/Tabs';
import TabItem from '@theme/TabItem';

# chaos_packet_drop

This gadget is used to simulate the random packet drops in the network based on independent (Bernoulli) probability model. 
The program runs at the tc hook point and can be configured to run at ingress/egress and for TCP/UDP packets 
and the drop probability percentage can also be configured. We can also drop packets of a specific IP/port number.

## Getting started

Running the gadget:

<Tabs groupId="env">
    <TabItem value="kubectl-gadget" label="kubectl gadget">
        ```bash
        $ kubectl gadget run ghcr.io/inspektor-gadget/gadget/chaos_packet_drop:%IG_TAG% [flags]
        ```
    </TabItem>

    <TabItem value="ig" label="ig">
        ```bash
        $ sudo ig run ghcr.io/inspektor-gadget/gadget/chaos_packet_drop:%IG_TAG% [flags]
        ```
    </TabItem>
</Tabs>

## Flags

### `--ipaddr_v4_filter`

This is a input filter parameter based on which the gadget randomly drops packets to/from this IPv4 address. 
It is input as a string in the CLI, it gets converted to a u32 int in kernel space. By default, its value is 0, which means all
the packets to all the IPv4 address will be dropped based on the loss_percentage. Gadget will throw error if we an input invalid IP address.

Default value: `0` -> corresponding to 0.0.0.0

(e.g., ipaddr_v4_filter = "127.0.0.1")

### `--ipaddr_v6_filter`

This is a input filter parameter based on which the gadget randomly drops packets to/from this IPv6 address. 
It is input as a string in the CLI, it gets converted to a u32 int in kernel space. By default, its value is ::, which means all
the packets to all the IPv6 address will be dropped based on the loss_percentage. Gadget will throw error if we input an invalid IP address.

Default value: `::`

(e.g., ipaddr_v6_filter = "2081:d8::1")

### `--egress`

Indicate whether the program is to be attached at the egress hookpoint

Default value: `true`

### `--filter-tcp`

Decide whether TCP packets should be filtered

Default value: `true`

### `--filter-udp`

Decide whether UDP packets should be filtered

Default value: `true`

### `--ingress`

Indicate whether the program is to be attached at the ingress hookpoint

Default value: `false`

### `--loss-percentage`

The percentage of packets to be dropped (e.g., 100)

Default value: `100`

### `--port`

Port number (e.g., 443)

Default value: `0`

## Guide

This gadget as mentioned before is used to drop TCP/UDP traffic. Let's create a test
container for the same to do the testing.

Let us create a busybox container and try blocking the egress packets
```bash
$ docker run -it --name test-pkt-drop busybox
```
This will take you inside the busybox container.

Meanwhile we can open another terminal and run the `chaos_packet_drop` gadget 
```bash
$ sudo ig run chaos_packet_drop:latest --containername test-pkt-drop --verify-image=false
```

Now once the gadget starts printing out put we can go back to the terminal where we are 
inside the busybox container the we can try the following command.
```bash 
/ # cd home
/home # wget http://80.249.99.148/1GB.zip
```
Here we are trying to download a 1GB file (from ipv4.download.thinkbroadband.com whose IP can be found by nslookup)

We see the following in the test-pkt-drop container

```
Connecting to 80.249.99.148 (80.249.99.148:80)
saving to '1GB.zip'
1GB.zip                0% |                                                           | 15580  - stalled -
```

On the gadget output we see 

```
WARN[0000] Ignoring runtime "cri-o" with non-existent socketPath "/run/crio/crio.sock" 
WARN[0001] image signature verification is disabled due to using corresponding option 
WARN[0001] image signature verification is disabled due to using corresponding option 
RUNTIME.CONTAINERNAME        DST                                   SRC                                   FILTER_IPV4                          DROP_CNT   INGR… EGRE… COMM                  PID
RUNTIME.CONTAINERNAME        DST                                   SRC                                   FILTER_IPV4                          DROP_CNT   INGR… EGRE… COMM                  PID
test-pkt-drop                80.249.99.148:53000                   172.17.0.2:53000                      0.0.0.0:0                            6          false true  wget              2645279
RUNTIME.CONTAINERNAME        DST                                   SRC                                   FILTER_IPV4                          DROP_CNT   INGR… EGRE… COMM                  PID
test-pkt-drop                80.249.99.148:53000                   172.17.0.2:53000                      0.0.0.0:0                            1          false true  ����`�        1955046299
RUNTIME.CONTAINERNAME        DST                                   SRC                                   FILTER_IPV4                          DROP_CNT   INGR… EGRE… COMM                  PID
test-pkt-drop                80.249.99.148:53000                   172.17.0.2:53000                      0.0.0.0:0                            1          false true  ����`�        1955046299
RUNTIME.CONTAINERNAME        DST                                   SRC                                   FILTER_IPV4                          DROP_CNT   INGR… EGRE… COMM                  PID
RUNTIME.CONTAINERNAME        DST                                   SRC                                   FILTER_IPV4                          DROP_CNT   INGR… EGRE… COMM                  PID
test-pkt-drop                80.249.99.148:53000                   172.17.0.2:53000                      0.0.0.0:0                            1          false true  ����`�        1955046299
RUNTIME.CONTAINERNAME        DST                                   SRC                                   FILTER_IPV4                          DROP_CNT   INGR… EGRE… COMM                  PID
RUNTIME.CONTAINERNAME        DST                                   SRC                                   FILTER_IPV4                          DROP_CNT   INGR… EGRE… COMM                  PID
RUNTIME.CONTAINERNAME        DST                                   SRC                                   FILTER_IPV4                          DROP_CNT   INGR… EGRE… COMM                  PID
RUNTIME.CONTAINERNAME        DST                                   SRC                                   FILTER_IPV4                          DROP_CNT   INGR… EGRE… COMM                  PID
RUNTIME.CONTAINERNAME        DST                                   SRC                                   FILTER_IPV4                          DROP_CNT   INGR… EGRE… COMM                  PID
RUNTIME.CONTAINERNAME        DST                                   SRC                                   FILTER_IPV4                          DROP_CNT   INGR… EGRE… COMM                  PID
test-pkt-drop                80.249.99.148:53000                   172.17.0.2:53000                      0.0.0.0:0                            1          false true  ����`�        1955046299
RUNTIME.CONTAINERNAME        DST                                   SRC                                   FILTER_IPV4                          DROP_CNT   INGR… EGRE… COMM                  PID
RUNTIME.CONTAINERNAME        DST                                   SRC                                   FILTER_IPV4                          DROP_CNT   INGR… EGRE… COMM                  PID
RUNTIME.CONTAINERNAME        DST                                   SRC                                   FILTER_IPV4                          DROP_CNT   INGR… EGRE… COMM                  PID
RUNTIME.CONTAINERNAME        DST                                   SRC                                   FILTER_IPV4                          DROP_CNT   INGR… EGRE… COMM                  PID
RUNTIME.CONTAINERNAME        DST                                   SRC                                   FILTER_IPV4                          DROP_CNT   INGR… EGRE… COMM                  PID
RUNTIME.CONTAINERNAME        DST                                   SRC                                   FILTER_IPV4                          DROP_CNT   INGR… EGRE… COMM                  PID
RUNTIME.CONTAINERNAME        DST                                   SRC                                   FILTER_IPV4                          DROP_CNT   INGR… EGRE… COMM                  PID
RUNTIME.CONTAINERNAME        DST                                   SRC                                   FILTER_IPV4                          DROP_CNT   INGR… EGRE… COMM                  PID
RUNTIME.CONTAINERNAME        DST                                   SRC                                   FILTER_IPV4                          DROP_CNT   INGR… EGRE… COMM                  PID
RUNTIME.CONTAINERNAME        DST                                   SRC                                   FILTER_IPV4                          DROP_CNT   INGR… EGRE… COMM                  PID
```
Here we can see that initially the packets are dropped from command `wget` and since this is a TCP based connection, we can also sort of see how the pakcets are being sent after
a certain backoff period. Here since `loss_percentage` is 100% all the packets are dropped and hence we couldn't download the file.

Let's try the same with `loss_percentage` as 50% and check the results

On the gadget terminal run
```bash
$ sudo ig run chaos_packet_drop:latest --containername test-pkt-drop --verify-image=false --loss_percentage=50
```
and in the test-pkt-drop container run the `# wget http://80.249.99.148/1GB.zip` command

here we see that the download happens now unlike later but slower than usual
```
1GB.zip                8% |************                                                                                                  | 88.7M  0:01:56 ETA
```
On the gadget terminal, the output is as follows

```
RUNTIME.CONTAINERNAME        DST                                   SRC                                   FILTER_IPV4                          DROP_CNT   INGR… EGRE… COMM                  PID
RUNTIME.CONTAINERNAME        DST                                   SRC                                   FILTER_IPV4                          DROP_CNT   INGR… EGRE… COMM                  PID
test-pkt-drop                80.249.99.148:50318                   172.17.0.2:50318                      0.0.0.0:0                            1          false true  wget              2653142
test-pkt-drop                80.249.99.148:50318                   172.17.0.2:50318                      0.0.0.0:0                            2          false true  ����           4294942639
test-pkt-drop                80.249.99.148:50318                   172.17.0.2:50318                      0.0.0.0:0                            75         false true  wget              2653142
test-pkt-drop                80.249.99.148:50318                   172.17.0.2:50318                      0.0.0.0:0                            1          false true  wget              2653142
RUNTIME.CONTAINERNAME        DST                                   SRC                                   FILTER_IPV4                          DROP_CNT   INGR… EGRE… COMM                  PID
test-pkt-drop                80.249.99.148:50318                   172.17.0.2:50318                      0.0.0.0:0                            8          false true                 4294967295
test-pkt-drop                80.249.99.148:50318                   172.17.0.2:50318                      0.0.0.0:0                            1          false true                          0
test-pkt-drop                80.249.99.148:50318                   172.17.0.2:50318                      0.0.0.0:0                            1          false true  ������������< 4294938032
test-pkt-drop                80.249.99.148:50318                   172.17.0.2:50318                      0.0.0.0:0                            496        false true                 4294967295
test-pkt-drop                80.249.99.148:50318                   172.17.0.2:50318                      0.0.0.0:0                            1          false true  ����h�                 0
test-pkt-drop                80.249.99.148:50318                   172.17.0.2:50318                      0.0.0.0:0                            2          false true  ����(��������…          0
test-pkt-drop                80.249.99.148:50318                   172.17.0.2:50318                      0.0.0.0:0                            6          false true  �����������… 4294938032
test-pkt-drop                80.249.99.148:50318                   172.17.0.2:50318                      0.0.0.0:0                            1          false true                         0
test-pkt-drop                80.249.99.148:50318                   172.17.0.2:50318                      0.0.0.0:0                            1          false true  wget              2653142
test-pkt-drop                80.249.99.148:50318                   172.17.0.2:50318                      0.0.0.0:0                            1          false true  wget              2653142
test-pkt-drop                80.249.99.148:50318                   172.17.0.2:50318                      0.0.0.0:0                            5          false true  ����h������< 4294938032
test-pkt-drop                80.249.99.148:50318                   172.17.0.2:50318                      0.0.0.0:0                            1          false true                          0
test-pkt-drop                80.249.99.148:50318                   172.17.0.2:50318                      0.0.0.0:0                            2          false true                4294938032
test-pkt-drop                80.249.99.148:50318                   172.17.0.2:50318                      0.0.0.0:0                            1          false true  ����           4294942639
test-pkt-drop                80.249.99.148:50318                   172.17.0.2:50318                      0.0.0.0:0                            1          false true  	              4294938032
test-pkt-drop                80.249.99.148:50318                   172.17.0.2:50318                      0.0.0.0:0                            1          false true  wget              2653142
test-pkt-drop                80.249.99.148:50318                   172.17.0.2:50318                      0.0.0.0:0                            1          false true                          0
test-pkt-drop                80.249.99.148:50318                   172.17.0.2:50318                      0.0.0.0:0                            1          false true  ����           4294938032
test-pkt-drop                80.249.99.148:50318                   172.17.0.2:50318                      0.0.0.0:0                            1          false true                4294967295
test-pkt-drop                80.249.99.148:50318                   172.17.0.2:50318                      0.0.0.0:0                            1          false true                         0
test-pkt-drop                80.249.99.148:50318                   172.17.0.2:50318                      0.0.0.0:0                            1          false true  ����           4294942639
test-pkt-drop                80.249.99.148:50318                   172.17.0.2:50318                      0.0.0.0:0                            398        false true  wget              2653142
test-pkt-drop                80.249.99.148:50318                   172.17.0.2:50318                      0.0.0.0:0                            34         false true  wget              2653142
test-pkt-drop                80.249.99.148:50318                   172.17.0.2:50318                      0.0.0.0:0                            1          false true                 4294967295
test-pkt-drop                80.249.99.148:50318                   172.17.0.2:50318                      0.0.0.0:0                            1          false true  ������,        4294938032
test-pkt-drop                80.249.99.148:50318                   172.17.0.2:50318                      0.0.0.0:0                            4          false true                 4294938032
test-pkt-drop                80.249.99.148:50318                   172.17.0.2:50318                      0.0.0.0:0                            1          false true                 4294938032
RUNTIME.CONTAINERNAME        DST                                   SRC                                   FILTER_IPV4                          DROP_CNT   INGR… EGRE… COMM                  PID
test-pkt-drop                80.249.99.148:50318                   172.17.0.2:50318                      0.0.0.0:0                            2          false true                 4294967295
test-pkt-drop                80.249.99.148:50318                   172.17.0.2:50318                      0.0.0.0:0                            300        false true                          0
test-pkt-drop                80.249.99.148:50318                   172.17.0.2:50318                      0.0.0.0:0                            5          false true                 4294967295
test-pkt-drop                80.249.99.148:50318                   172.17.0.2:50318                      0.0.0.0:0                            1121       false true                 4294967295
test-pkt-drop                80.249.99.148:50318                   172.17.0.2:50318                      0.0.0.0:0                            3          false true  ����           4294938032
test-pkt-drop                80.249.99.148:50318                   172.17.0.2:50318                      0.0.0.0:0                            1          false true  �����������… 4294938032
test-pkt-drop                80.249.99.148:50318                   172.17.0.2:50318                      0.0.0.0:0                            1          false true  wget              2653142
test-pkt-drop                80.249.99.148:50318                   172.17.0.2:50318                      0.0.0.0:0                            4          false true  ����(�������; 4294967295
test-pkt-drop                80.249.99.148:50318                   172.17.0.2:50318                      0.0.0.0:0                            1          false true                          0
test-pkt-drop                80.249.99.148:50318                   172.17.0.2:50318                      0.0.0.0:0                            4          false true  	              4294938032
```